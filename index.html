import React, { useState, useRef, useEffect } from 'react';
import { Upload, Camera, Download, X, Move, RotateCw, ZoomIn, Shirt, Layers, Sparkles, Scissors } from 'lucide-react';

export default function App() {
  // Durum yÃ¶netimi (State)
  const [baseImage, setBaseImage] = useState(null);
  const [overlays, setOverlays] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
  
  // Canvas referansÄ±
  const containerRef = useRef(null);

  // Ã–rnek kÄ±yafet/aksesuar veritabanÄ± (SVG Placeholderlar)
  const defaultItems = [
    { type: 'sunglasses', label: 'GÃ¼neÅŸ GÃ¶zlÃ¼ÄŸÃ¼', icon: 'ðŸ•¶ï¸' },
    { type: 'hat', label: 'Åžapka', icon: 'ðŸ§¢' },
    { type: 'shirt', label: 'TiÅŸÃ¶rt', icon: 'ðŸ‘•' },
    { type: 'necklace', label: 'Kolye', icon: 'ðŸ“¿' },
  ];

  // Resim YÃ¼kleme
  const handleImageUpload = (e, type) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        if (type === 'base') {
          setBaseImage(event.target.result);
        } else {
          addOverlay(event.target.result, 'custom');
        }
      };
      reader.readAsDataURL(file);
    }
  };

  // Katman Ekleme
  const addOverlay = (src, type) => {
    const newOverlay = {
      id: Date.now(),
      src: src,
      type: type,
      x: 50, // BaÅŸlangÄ±Ã§ X (yÃ¼zde)
      y: 50, // BaÅŸlangÄ±Ã§ Y (yÃ¼zde)
      scale: 1,
      rotation: 0,
    };
    setOverlays([...overlays, newOverlay]);
    setSelectedId(newOverlay.id);
  };

  // SVG oluÅŸturucu (Demo amaÃ§lÄ± placeholder gÃ¶rseller)
  const createSvgUrl = (emoji) => {
    const svgString = `
      <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="80">${emoji}</text>
      </svg>
    `;
    return `data:image/svg+xml;base64,${btoa(decodeURIComponent(encodeURIComponent(svgString)))}`;
  };

  // SeÃ§ili Ã¶ÄŸeyi gÃ¼ncelleme
  const updateSelected = (prop, value) => {
    setOverlays(overlays.map(item => 
      item.id === selectedId ? { ...item, [prop]: value } : item
    ));
  };

  // SÃ¼rÃ¼kleme MantÄ±ÄŸÄ±
  const handleMouseDown = (e, id) => {
    e.stopPropagation();
    setSelectedId(id);
    setIsDragging(true);
    
    const item = overlays.find(o => o.id === id);
    const containerRect = containerRef.current.getBoundingClientRect();
    
    // Mouse pozisyonunu yÃ¼zdeye Ã§evir
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    setDragOffset({
      x: clientX - (containerRect.left + (containerRect.width * item.x / 100)),
      y: clientY - (containerRect.top + (containerRect.height * item.y / 100))
    });
  };

  const handleMouseMove = (e) => {
    if (!isDragging || !selectedId) return;

    const containerRect = containerRef.current.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    // Yeni pozisyonu hesapla (yÃ¼zde olarak)
    let newX = ((clientX - dragOffset.x) - containerRect.left) / containerRect.width * 100;
    let newY = ((clientY - dragOffset.y) - containerRect.top) / containerRect.height * 100;

    setOverlays(overlays.map(item => 
      item.id === selectedId ? { ...item, x: newX, y: newY } : item
    ));
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  // Klavye ile silme
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Delete' && selectedId) {
        setOverlays(overlays.filter(o => o.id !== selectedId));
        setSelectedId(null);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [selectedId, overlays]);

  return (
    <div 
      className="flex flex-col h-screen bg-slate-900 text-white font-sans"
      onMouseMove={handleMouseMove}
      onTouchMove={handleMouseMove}
      onMouseUp={handleMouseUp}
      onTouchEnd={handleMouseUp}
    >
      {/* Header */}
      <header className="bg-slate-950 p-4 border-b border-slate-800 flex justify-between items-center shadow-lg z-20">
        <div className="flex items-center gap-2">
          <div className="bg-indigo-600 p-2 rounded-lg">
            <Sparkles className="w-6 h-6 text-white" />
          </div>
          <h1 className="text-xl font-bold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
            MODA AI STÃœDYOSU
          </h1>
        </div>
        <button className="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-2">
          <Download size={16} /> Kaydet
        </button>
      </header>

      <main className="flex-1 flex overflow-hidden">
        {/* Sol Panel: AraÃ§lar */}
        <aside className="w-64 bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-6 overflow-y-auto z-10 shadow-xl">
          
          {/* Ana Resim YÃ¼kleme */}
          <div className="space-y-2">
            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">Model</h3>
            <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-700 rounded-xl hover:border-indigo-500 hover:bg-slate-800 transition cursor-pointer group">
              <Camera className="w-8 h-8 text-slate-500 group-hover:text-indigo-400 mb-2" />
              <span className="text-xs text-slate-400 group-hover:text-white">FotoÄŸraf YÃ¼kle</span>
              <input type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, 'base')} />
            </label>
          </div>

          {/* GardÄ±rop */}
          <div className="space-y-2">
            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">GardÄ±rop</h3>
            <div className="grid grid-cols-2 gap-2">
              {defaultItems.map((item, idx) => (
                <button 
                  key={idx}
                  onClick={() => addOverlay(createSvgUrl(item.icon), 'preset')}
                  className="bg-slate-800 hover:bg-slate-700 p-3 rounded-lg flex flex-col items-center gap-2 transition border border-slate-700 hover:border-indigo-500"
                >
                  <div className="text-2xl">{item.icon}</div>
                  <span className="text-[10px] text-slate-300">{item.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Ã–zel KÄ±yafet YÃ¼kleme */}
          <div className="space-y-2">
             <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest">Kendi KÄ±yafetin</h3>
             <label className="flex items-center justify-center gap-2 w-full py-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 border border-slate-700 transition">
                <Upload size={16} className="text-indigo-400"/>
                <span className="text-xs">PNG YÃ¼kle</span>
                <input type="file" className="hidden" accept="image/png,image/jpeg" onChange={(e) => handleImageUpload(e, 'overlay')} />
             </label>
          </div>
        </aside>

        {/* Orta Alan: Canvas */}
        <section className="flex-1 bg-[#0f172a] relative overflow-hidden flex items-center justify-center p-8">
          <div 
            className="relative w-full h-full max-w-2xl max-h-[80vh] bg-slate-950 rounded-lg shadow-2xl overflow-hidden flex items-center justify-center border border-slate-800 select-none"
            ref={containerRef}
          >
            {baseImage ? (
              <img 
                src={baseImage} 
                alt="Base" 
                className="absolute w-full h-full object-contain pointer-events-none"
              />
            ) : (
              <div className="text-center p-10">
                <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                   <Camera className="w-10 h-10 text-slate-600" />
                </div>
                <p className="text-slate-500 text-lg">BaÅŸlamak iÃ§in bir fotoÄŸraf yÃ¼kleyin</p>
              </div>
            )}

            {/* Katmanlar */}
            {overlays.map((item) => (
              <div
                key={item.id}
                onMouseDown={(e) => handleMouseDown(e, item.id)}
                onTouchStart={(e) => handleMouseDown(e, item.id)}
                style={{
                  position: 'absolute',
                  left: `${item.x}%`,
                  top: `${item.y}%`,
                  transform: `translate(-50%, -50%) scale(${item.scale}) rotate(${item.rotation}deg)`,
                  cursor: isDragging && selectedId === item.id ? 'grabbing' : 'grab',
                  zIndex: selectedId === item.id ? 50 : 10,
                }}
                className={`group ${selectedId === item.id ? 'ring-2 ring-indigo-500 rounded-lg' : ''}`}
              >
                <img 
                  src={item.src} 
                  alt="Overlay" 
                  className="pointer-events-none max-w-[200px] max-h-[200px]" 
                  style={{ filter: 'drop-shadow(0 4px 6px rgba(0,0,0,0.3))' }}
                />
                
                {selectedId === item.id && (
                  <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">
                    TaÅŸÄ±
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>

        {/* SaÄŸ Panel: Kontrol */}
        {selectedId ? (
          <aside className="w-72 bg-slate-900 border-l border-slate-800 p-6 flex flex-col gap-6 z-10 shadow-xl">
            <div className="flex justify-between items-center border-b border-slate-800 pb-4">
              <h2 className="font-bold text-indigo-400 flex items-center gap-2">
                <Layers size={18} />
                DÃ¼zenle
              </h2>
              <button 
                onClick={() => {
                  setOverlays(overlays.filter(o => o.id !== selectedId));
                  setSelectedId(null);
                }}
                className="text-red-400 hover:text-red-300 transition"
              >
                <Scissors size={18} />
              </button>
            </div>

            <div className="space-y-6">
              {/* BÃ¼yÃ¼tme */}
              <div className="space-y-2">
                <div className="flex justify-between text-xs text-slate-400">
                  <span className="flex items-center gap-1"><ZoomIn size={12}/> Boyut</span>
                  <span>{overlays.find(o => o.id === selectedId).scale.toFixed(1)}x</span>
                </div>
                <input 
                  type="range" 
                  min="0.1" 
                  max="3" 
                  step="0.1" 
                  value={overlays.find(o => o.id === selectedId).scale}
                  onChange={(e) => updateSelected('scale', parseFloat(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                />
              </div>

              {/* DÃ¶ndÃ¼rme */}
              <div className="space-y-2">
                 <div className="flex justify-between text-xs text-slate-400">
                  <span className="flex items-center gap-1"><RotateCw size={12}/> DÃ¶ndÃ¼r</span>
                  <span>{overlays.find(o => o.id === selectedId).rotation}Â°</span>
                </div>
                <input 
                  type="range" 
                  min="0" 
                  max="360" 
                  value={overlays.find(o => o.id === selectedId).rotation}
                  onChange={(e) => updateSelected('rotation', parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                />
              </div>
            </div>

            <div className="mt-auto p-4 bg-slate-800 rounded-lg text-xs text-slate-400 leading-relaxed">
              <p>ðŸ’¡ <strong>Ä°pucu:</strong> KÄ±yafeti hareket ettirmek iÃ§in Ã¼zerine basÄ±lÄ± tut ve sÃ¼rÃ¼kle.</p>
            </div>
          </aside>
        ) : (
          <aside className="w-72 bg-slate-900 border-l border-slate-800 flex items-center justify-center text-slate-500 p-6 text-center text-sm">
            <p>DÃ¼zenlemek iÃ§in ekrana bir kÄ±yafet ekleyin ve Ã¼zerine tÄ±klayÄ±n.</p>
          </aside>
        )}
      </main>
    </div>
  );
}
