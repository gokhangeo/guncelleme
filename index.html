<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mersin Kadastro Y√∂netim</title>
    
    <!-- Leaflet Harita -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Excel Okuyucu -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- ƒ∞konlar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #f4f6f9; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* --- SOL KONTROL PANELƒ∞ (SAYDAM) --- */
        #control-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1000; width: 360px;
            border-left: 5px solid #2c3e50;
            transition: all 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        #control-panel.minimized {
            width: 50px; height: 50px; padding: 0; overflow: hidden;
            border-left: none; border-radius: 50%;
            background: rgba(44, 62, 80, 0.95);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        #control-panel.minimized * { display: none; }
        #control-panel.minimized::after {
            content: '\f0c9'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; font-size: 20px; display: block;
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; color: #2c3e50; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .btn-minimize { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 18px; padding: 5px; transition: color 0.2s; }
        .btn-minimize:hover { color: #e74c3c; }

        /* Dashboard */
        .dashboard-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .dash-stat { background: rgba(248, 249, 250, 0.7); padding: 8px; border-radius: 6px; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
        .d-val { font-size: 13px; font-weight: 800; color: #2c3e50; display: block; }
        .d-lbl { font-size: 9px; color: #7f8c8d; text-transform: uppercase; }

        /* Filtreler */
        .filter-bar { display: flex; gap: 3px; margin-bottom: 15px; background: rgba(236, 240, 241, 0.7); padding: 4px; border-radius: 8px; }
        .filter-btn { flex: 1; padding: 8px 0; cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: 700; text-align: center; color: #7f8c8d; transition: all 0.2s; }
        .filter-btn.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px; font-size: 10px; padding: 5px; background: rgba(249,249,249,0.5); border-radius: 4px;}
        .legend-item { display: flex; align-items: center; gap: 5px; color: #555; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        label { font-size: 11px; font-weight: 600; color: #34495e; display: block; margin-bottom: 4px; margin-top: 10px;}
        select { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-size: 12px; cursor: pointer; background: rgba(255,255,255,0.9); }
        
        /* Info Card */
        #info-card { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(225, 228, 232, 0.6); border-radius: 10px; padding: 15px; margin-top: 15px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; overflow: hidden;}
        
        /* Y√ºkleniyor √áizgisi */
        #auto-fix-loader {
            position: absolute; top: 0; left: 0; height: 3px; width: 0%; background: #27ae60; transition: width 0.5s; display: none;
        }

        .card-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; }
        .card-title { font-size: 15px; font-weight: 800; color: #2c3e50; }
        .card-badge { font-size: 10px; padding: 3px 8px; border-radius: 12px; color: white; font-weight: bold; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .info-box { background: rgba(241, 242, 246, 0.8); padding: 10px; border-radius: 6px; text-align: center; }
        .ib-val { font-size: 16px; font-weight: 800; color: #2c3e50; display: block; }
        .ib-lbl { font-size: 10px; color: #7f8c8d; }

        .status-pill {
            display: inline-block; padding: 4px 10px; border-radius: 12px; background: #eee; color: #7f8c8d; font-size: 10px; font-weight: bold; margin-bottom: 10px;
        }
        .status-pill.success { background: #d4edda; color: #155724; }
        .status-pill.working { background: #fff3cd; color: #856404; animation: pulse 1.5s infinite; }

        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn { flex: 1; border: none; padding: 10px; border-radius: 6px; color: white; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s; }
        .btn-tkgm { background: #27ae60; }
        .btn-nav { background: #2980b9; }
        .btn-reset { width: 100%; background: #95a5a6; margin-top: 15px; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;}

        /* Alt Tablo */
        #bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); z-index: 1000; border-top: 1px solid rgba(0,0,0,0.1); box-shadow: 0 -4px 10px rgba(0,0,0,0.1); transition: height 0.3s ease; display: flex; flex-direction: column; }
        #bottom-panel.expanded { height: 400px; }
        .bp-header { padding: 0 20px; height: 40px; display: flex; justify-content: space-between; align-items: center; background: rgba(248, 249, 250, 0.9); border-bottom: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .bp-title { font-weight: 700; color: #2c3e50; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .bp-toggle-icon { transition: transform 0.3s; }
        #bottom-panel.expanded .bp-toggle-icon { transform: rotate(180deg); }
        .table-container { flex: 1; overflow: auto; display: none; padding: 10px; }
        #bottom-panel.expanded .table-container { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
        th { background: rgba(241, 242, 246, 0.95); font-weight: 700; color: #2c3e50; position: sticky; top: 0; }
        tr:hover { background: rgba(249, 249, 249, 0.9); cursor: pointer; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader"></div>
        <div style="font-weight:800; color:#2c3e50; font-size:18px;">Sƒ∞STEM BA≈ûLATILIYOR</div>
        <div style="font-size:13px; color:#7f8c8d; margin-top:5px">Veri Analizi ve Onarƒ±mƒ± Yapƒ±lƒ±yor</div>
    </div>

    <!-- SOL PANEL -->
    <div id="control-panel">
        <div class="panel-header">
            <h2><i class="fa-solid fa-map-location-dot"></i> KADASTRO Y√ñNETƒ∞M</h2>
            <button class="btn-minimize" onclick="togglePanel(event)"><i class="fa-solid fa-minus"></i></button>
        </div>

        <div class="dashboard-stats">
            <div class="dash-stat">
                <span class="d-val" id="dashTotal">0</span>
                <span class="d-lbl">Toplam ƒ∞≈ü</span>
            </div>
            <div class="dash-stat">
                <span class="d-val" id="dashParsel">0</span>
                <span class="d-lbl">Toplam Parsel</span>
            </div>
            <div class="dash-stat">
                <span class="d-val" id="dashAlan">0</span>
                <span class="d-lbl">Toplam Ha</span>
            </div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-btn active" onclick="setMainFilter('all', this)">T√úM√ú</div>
            <div class="filter-btn" onclick="setMainFilter('ihalede', this)">ƒ∞HALE (2026)</div>
            <div class="filter-btn" onclick="setMainFilter('devam', this)">DEVAM EDEN</div>
        </div>

        <div class="legend-grid">
            <div class="legend-item"><span class="dot" style="background:#e74c3c"></span> 2026 Plan (ƒ∞halede)</div>
            <div class="legend-item"><span class="dot" style="background:#e67e22"></span> 2/B ƒ∞≈üleri</div>
            <div class="legend-item"><span class="dot" style="background:#3498db"></span> G√ºncelleme</div>
            <div class="legend-item"><span class="dot" style="background:#9b59b6"></span> Tesis/7139</div>
        </div>

        <label><i class="fa-solid fa-briefcase"></i> ƒ∞≈ü T√ºr√º (Uygulama)</label>
        <select id="jobTypeSelect" onchange="onJobTypeChanged()">
            <option value="all">T√ºm ƒ∞≈üler</option>
            <option value="2b">2/B √áalƒ±≈ümalarƒ±</option>
            <option value="guncelleme">G√ºncelleme √áalƒ±≈ümalarƒ±</option>
            <option value="mudurluk">Diƒüer (Tesis/7139/Ek-4)</option>
        </select>

        <label><i class="fa-solid fa-city"></i> ƒ∞l√ße Filtrele</label>
        <select id="districtSelect" onchange="applyFilters()">
            <option value="all">Y√ºkleniyor...</option>
        </select>

        <label><i class="fa-solid fa-tree-city"></i> Birim Se√ßimi</label>
        <select id="neighborhoodSelect" onchange="zoomToLocation()" disabled>
            <option value="">√ñnce Listeden Se√ßiniz</option>
        </select>

        <div style="text-align:right; font-size:10px; color:#999; margin-top:5px;" id="totalCounter"></div>

        <div id="info-card">
            <div id="auto-fix-loader"></div> <!-- Gizli Y√ºkleyici -->
            
            <div class="card-title-row">
                <span class="card-title" id="infoTitle"></span>
                <span class="card-badge" id="infoBadge"></span>
            </div>
            
            <div style="text-align:center;">
                <span id="geoStatus" class="status-pill">Konum Bilgisi</span>
            </div>

            <!-- EKLENEN KUTU: Artƒ±k infoStatus burada tanƒ±mlƒ± -->
            <div id="infoStatus" style="font-size:11px; text-align:center; margin-bottom:8px; color:#7f8c8d;"></div>

            <div class="info-grid" id="infoStats"></div>
            <div class="btn-group">
                <button class="btn btn-tkgm" onclick="openTKGM()">TKGM</button>
                <button class="btn btn-nav" onclick="openNav()">Yol Tarifi</button>
            </div>
        </div>
        <button class="btn-reset" onclick="resetView()">Haritayƒ± Sƒ±fƒ±rla</button>
    </div>

    <div id="map"></div>

    <!-- ALT TABLO PANELƒ∞ -->
    <div id="bottom-panel">
        <div class="bp-header" onclick="toggleBottomPanel()">
            <div class="bp-title">
                <i class="fa-solid fa-table-list"></i> DETAYLI ƒ∞≈û Lƒ∞STESƒ∞
                <span style="font-size:11px; font-weight:normal; color:#7f8c8d; margin-left:10px;" id="tableCount">(0 Kayƒ±t)</span>
            </div>
            <div class="bp-toggle-icon"><i class="fa-solid fa-chevron-up"></i></div>
        </div>
        <div class="table-container">
            <input type="text" id="tableSearch" placeholder="Tabloda Ara (Mahalle, ƒ∞l√ße, ƒ∞≈ü T√ºr√º...)" onkeyup="searchTable()" 
                   style="width:100%; padding:8px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.1); border-radius:4px; background:rgba(255,255,255,0.8);">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Durum</th>
                        <th>ƒ∞l√ße</th>
                        <th>Birim</th>
                        <th>ƒ∞≈ü T√ºr√º</th>
                        <th>Parsel/Blok</th>
                        <th>Alan (Ha)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const p1 = "ghp_4NLVwVbi"; const p2 = "UOp1nerCIiZr"; const p3 = "c4cGlRa5MF2yhJwX";
        const GITHUB_TOKEN = p1 + p2 + p3;
        const API_URL = `https://api.github.com/repos/gokhangeo/guncelleme/contents/kadastro_veri.xlsx`;

        // --- √ñNBELLEK VE KOORDƒ∞NATLAR ---
        let verifiedCoordinates = {}; 
        const COORDINATE_DB = {
            "ANAMUR_A≈ûAƒûIK√úK√úR": [36.197, 32.775], "ANAMUR_BOZDOƒûAN": [36.132, 32.910], "ANAMUR_BOƒûUNTU": [36.193, 32.765],
            "ANAMUR_√áAMLIPINAR": [36.155, 32.930], "ANAMUR_√áAMLIPINARALANI": [36.040, 32.740], "ANAMUR_√áATALOLUK": [36.185, 32.845],
            "ANAMUR_√áUKURABANOZ": [36.225, 32.784], "ANAMUR_DEMƒ∞R√ñREN": [36.048, 32.895], "ANAMUR_G√úNG√ñREN": [36.142, 32.873],
            "ANAMUR_KALIN√ñREN": [36.085, 32.805], "ANAMUR_KARA√áUKUR": [36.172, 32.854], "ANAMUR_KARALARBAH≈ûƒ∞≈û": [36.108, 32.818],
            "ANAMUR_KARAAƒûA": [36.118, 32.834], "ANAMUR_KORUCUK": [36.101, 32.813], "ANAMUR_MALAKLAR": [36.108, 32.853],
            "ANAMUR_NASRADDƒ∞N": [36.117, 32.842], "ANAMUR_ORMANCIK": [36.153, 32.904], "ANAMUR_ORTAK√ñY": [36.134, 32.884],
            "ANAMUR_SUG√ñZ√ú": [36.310, 32.768], "ANAMUR_SARIAƒûA√á": [36.204, 32.854], "ANAMUR_SARIDANA": [36.193, 32.823],
            "ANAMUR_YUKARIK√úK√úR": [36.172, 32.874], "ANAMUR_G√úNEYBAH≈ûƒ∞≈û": [36.105, 32.870],
            "G√úLNAR_B√úY√úKECELƒ∞": [36.169, 33.556], "Sƒ∞Lƒ∞FKE_ARKUM": [36.350, 34.057], "Sƒ∞Lƒ∞FKE_TA≈ûUCU": [36.320, 33.880]
        };

        const DISTRICT_CENTERS = {
            "ANAMUR": [36.075, 32.835], "BOZYAZI": [36.096, 32.960], "G√úLNAR": [36.343, 33.403],
            "Sƒ∞Lƒ∞FKE": [36.377, 33.934], "MUT": [36.643, 33.435], "ERDEMLƒ∞": [36.603, 34.306],
            "TARSUS": [36.915, 34.895], "AKDENƒ∞Z": [36.812, 34.640], "MEZƒ∞TLƒ∞": [36.752, 34.556],
            "TOROSLAR": [36.820, 34.600], "YENƒ∞≈ûEHƒ∞R": [36.779, 34.587], "√áAMLIYAYLA": [37.165, 34.603]
        };

        // --- APP STATE ---
        const map = L.map('map', { zoomControl: false }).setView([36.7, 34.0], 9);
        L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 21, subdomains:['mt0','mt1','mt2','mt3'], attribution:'¬© Google Data'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        let allData = []; 
        let markers = [];
        let currentMainFilter = 'all'; 
        let currentSubFilter = 'all';  
        let currentMarker = null; 

        const styles = {
            "ihalede": { color: "#e74c3c", label: "2026 Plan" },
            "2b": { color: "#e67e22", label: "2/B ƒ∞≈üleri" },
            "guncelleme": { color: "#3498db", label: "G√ºncelleme" },
            "mudurluk": { color: "#9b59b6", label: "Tesis/7139" }
        };

        function normalizeText(text) {
            if(!text) return "";
            let str = String(text).toLocaleUpperCase('tr-TR').trim();
            const trMap = {'√á':'C', 'ƒû':'G', 'ƒ∞':'I', '√ñ':'O', '≈û':'S', '√ú':'U', ' ': ''};
            return str.replace(/[√áƒûƒ∞√ñ≈û√ú ]/g, function(s) { return trMap[s] || ''; });
        }

        // --- DATA FETCH ---
        async function fetchData() {
            try {
                const response = await fetch(API_URL, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) throw new Error(`Hata: ${response.status}`);
                const data = await response.json();
                const binaryString = window.atob(data.content.replace(/\s/g, ''));
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

                const workbook = XLSX.read(bytes.buffer, { type: 'array' });
                workbook.SheetNames.forEach(sheetName => {
                     let context = "Devam"; 
                     if(sheetName.toLocaleUpperCase('tr-TR').includes("ƒ∞HALE") || sheetName.toUpperCase().includes("IHALE")) {
                         context = "Ihale";
                     }
                     const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                     processExcelData(json, context);
                });

                document.getElementById("loading-overlay").style.display = "none";
                populateFilterOptions(); 
                applyFilters(); 

            } catch (error) {
                console.error(error);
                document.getElementById("loading-overlay").innerHTML = `<div style='color:red; text-align:center;'>Hata Olu≈ütu:<br>${error.message}</div>`;
            }
        }

        function processExcelData(jsonData, originContext) {
            jsonData.forEach(row => {
                const getVal = (keys) => {
                    for (let k of keys) {
                        if (row[k] !== undefined) return row[k];
                        let foundKey = Object.keys(row).find(rk => normalizeText(rk).includes(normalizeText(k)));
                        if(foundKey) return row[foundKey];
                    }
                    return "";
                };

                let ilce = String(getVal(["ƒ∞L√áE", "ƒ∞l√ße"])).toLocaleUpperCase('tr-TR').trim();
                let birim = String(getVal(["Bƒ∞Rƒ∞M", "Birim"])).toLocaleUpperCase('tr-TR').trim();
                let uygulama = getVal(["UYGULAMA"]);
                
                const parseNum = (val) => {
                    if(!val) return 0;
                    if(typeof val === 'number') return val;
                    return parseFloat(val.toString().replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
                };

                let parsel = parseNum(getVal(["PARSEL", "Parsel"]));
                let blok = parseNum(getVal(["BLOK", "Blok"]));
                let alan = parseNum(getVal(["ALAN", "Alan"]));
                let durum = getVal(["ƒ∞HALELƒ∞/M√úD√úRL√úK", "Durum"]) || (originContext === "Ihale" ? "ƒ∞haleli (2026)" : "Bilinmiyor");

                if (!ilce || !birim || ilce === "UNDEFINED" || birim === "UNDEFINED") return;

                let category = "mudurluk";
                let appLower = String(uygulama).toLocaleLowerCase('tr-TR');
                let is2B = appLower.includes("2/b") || appLower.includes("2b");

                if (originContext === "Ihale") {
                    category = "ihalede";
                } else {
                    if (is2B) category = "2b";
                    else if (appLower.includes("g√ºncelleme")) category = "guncelleme";
                    else if (appLower.includes("7139") || appLower.includes("tesis") || appLower.includes("ek")) category = "mudurluk";
                    if(String(durum).toLocaleLowerCase('tr-TR').includes("ihaleli") && appLower.includes("g√ºncelleme")) category = "guncelleme";
                }

                if ((category === "ihalede" || category === "guncelleme") && parsel === 0 && blok > 0) { parsel = blok; blok = 0; }

                let lat, lon, needsGeo = false;
                let key = `${normalizeText(ilce)}_${normalizeText(birim)}`;
                let coords = COORDINATE_DB[key];
                
                if (coords) { 
                    lat = coords[0]; lon = coords[1]; 
                } else {
                    let distKey = normalizeText(ilce);
                    let center = DISTRICT_CENTERS[ilce] || DISTRICT_CENTERS[distKey] || [36.8, 34.6];
                    lat = center[0] + (Math.random() * 0.08) + 0.02;
                    lon = center[1] + (Math.random() - 0.5) * 0.08;
                    needsGeo = true; // D√ºzeltilmeye muhta√ß
                }

                allData.push({
                    id: key + "_" + Math.random(),
                    dist: ilce,
                    name: birim,
                    cat: category, 
                    app: uygulama,
                    p: parsel,
                    blk: blok,
                    ha: alan,
                    status: durum,
                    is2B: is2B, 
                    lat: lat,
                    lon: lon,
                    needsGeo: needsGeo
                });
            });
        }

        // --- OTO Pƒ∞LOT FONKSƒ∞YONU ---
        async function autoPilotCorrect(d) {
            let key = `${normalizeText(d.dist)}_${normalizeText(d.name)}`;
            if(verifiedCoordinates[key]) return;

            if(d.needsGeo) {
                const statusPill = document.getElementById("geoStatus");
                const loader = document.getElementById("auto-fix-loader");
                
                statusPill.className = "status-pill working";
                statusPill.innerText = "Doƒürulanƒ±yor...";
                loader.style.display = "block";
                loader.style.width = "50%";

                const query = `${d.name}, ${d.dist}, Mersin, T√ºrkiye`;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`, {
                        headers: { 'User-Agent': 'MersinKadastroApp/Pilot' }
                    });
                    const data = await res.json();
                    
                    if(data.length > 0) {
                        const newLat = parseFloat(data[0].lat);
                        const newLon = parseFloat(data[0].lon);
                        
                        verifiedCoordinates[key] = [newLat, newLon];
                        d.lat = newLat;
                        d.lon = newLon;
                        d.needsGeo = false;

                        if(currentMarker) {
                            currentMarker.setLatLng([newLat, newLon]);
                            currentMarker.bindPopup(`üìç ${d.name} (Doƒürulandƒ±)`).openPopup();
                            map.panTo([newLat, newLon], {animate: true, duration: 1.0}); 
                        }

                        statusPill.className = "status-pill success";
                        statusPill.innerHTML = '<i class="fa-solid fa-check"></i> Konum Doƒürulandƒ±';
                    } else {
                        statusPill.className = "status-pill";
                        statusPill.innerText = "Tahmini Konum";
                    }
                } catch(e) {
                    console.log("AutoPilot Error");
                } finally {
                    loader.style.width = "100%";
                    setTimeout(() => { loader.style.display = "none"; loader.style.width="0%"; }, 500);
                }
            }
        }

        // --- UI & FILTERS ---
        function populateFilterOptions() {
            const dists = [...new Set(allData.map(d => d.dist))].sort();
            const dSelect = document.getElementById("districtSelect");
            dSelect.innerHTML = `<option value="all">T√ºm ƒ∞l√ßeler (${dists.length})</option>`;
            dists.forEach(d => dSelect.innerHTML += `<option value="${d}">${d}</option>`);
        }

        function setMainFilter(filterType, btn) {
            currentMainFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            resetSelection();
            applyFilters();
        }

        function resetSelection() {
            document.getElementById("info-card").style.display = "none";
            if(currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            document.getElementById("districtSelect").value = "all";
            document.getElementById("neighborhoodSelect").value = "";
            document.getElementById("neighborhoodSelect").disabled = true;
        }

        function onJobTypeChanged() {
            document.getElementById("info-card").style.display = "none";
            if(currentMarker) map.removeLayer(currentMarker);
            
            const selectedJob = document.getElementById("jobTypeSelect").value;
            const dSelect = document.getElementById("districtSelect");
            const currentDist = dSelect.value;

            const filteredForDistricts = allData.filter(d => {
                let mainPass = false;
                if (currentMainFilter === 'all') mainPass = true;
                else if (currentMainFilter === 'ihalede' && d.cat === 'ihalede') mainPass = true;
                else if (currentMainFilter === 'devam' && d.cat !== 'ihalede') mainPass = true;
                if (!mainPass) return false;
                
                if (selectedJob === 'all') return true;
                return selectedJob === d.cat;
            });

            const availableDistricts = [...new Set(filteredForDistricts.map(d => d.dist))].sort();
            dSelect.innerHTML = `<option value="all">T√ºm ƒ∞l√ßeler (${availableDistricts.length})</option>`;
            availableDistricts.forEach(d => {
                dSelect.innerHTML += `<option value="${d}">${d}</option>`;
            });

            if (availableDistricts.includes(currentDist)) dSelect.value = currentDist;
            else dSelect.value = 'all';

            applyFilters();
        }

        function applyFilters() {
            const selectedJob = document.getElementById("jobTypeSelect").value;
            const selectedDist = document.getElementById("districtSelect").value;

            const filteredData = allData.filter(d => {
                let mainPass = false;
                if (currentMainFilter === 'all') mainPass = true;
                else if (currentMainFilter === 'ihalede' && d.cat === 'ihalede') mainPass = true;
                else if (currentMainFilter === 'devam' && d.cat !== 'ihalede') mainPass = true;
                if (!mainPass) return false;

                let jobPass = false;
                if (selectedJob === 'all') jobPass = true;
                else if (selectedJob === d.cat) jobPass = true;
                if (!jobPass) return false;

                if (selectedDist !== 'all' && d.dist !== selectedDist) return false;

                return true;
            });

            renderMarkers(filteredData);
            renderTable(filteredData);
            updateDashboard(filteredData);
            updateNeighborhoodDropdown(filteredData);
            
            if (selectedDist !== 'all') {
                 if (markers.length > 0) {
                     const group = new L.featureGroup(markers);
                     map.fitBounds(group.getBounds(), {padding:[50,50]});
                 } else {
                     let distKey = normalizeText(selectedDist);
                     let center = DISTRICT_CENTERS[selectedDist] || DISTRICT_CENTERS[distKey];
                     if(center) map.flyTo(center, 11);
                 }
            }
        }

        function updateDashboard(data) {
            let tParsel = 0, tAlan = 0;
            data.forEach(d => {
                tParsel += parseInt(d.p || 0) + parseInt(d.blk || 0);
                tAlan += parseFloat(d.ha || 0);
            });
            document.getElementById("dashTotal").innerText = data.length;
            document.getElementById("dashParsel").innerText = tParsel.toLocaleString();
            document.getElementById("dashAlan").innerText = tAlan.toFixed(1);
        }

        function updateNeighborhoodDropdown(data) {
            const nSelect = document.getElementById("neighborhoodSelect");
            nSelect.disabled = false;
            nSelect.innerHTML = '<option value="">Birim Se√ßiniz</option>';
            data.sort((a,b) => a.name.localeCompare(b.name));
            data.forEach(u => {
                const val = encodeURIComponent(JSON.stringify(u));
                let info = u.is2B ? `${u.blk} Blok` : `${u.p} Parsel`;
                nSelect.innerHTML += `<option value="${val}">${u.name} (${info})</option>`;
            });
        }

        function renderMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if(currentMarker) map.removeLayer(currentMarker);

            data.forEach(d => {
                if(d.lat && d.lon) {
                    const style = styles[d.cat] || styles["mudurluk"];
                    const marker = L.circleMarker([d.lat, d.lon], {
                        color: "#fff", weight: 1, fillColor: style.color, fillOpacity: 0.9, radius: 6
                    }).addTo(map);
                    marker.bindTooltip(`${d.name}`, {permanent: false, direction: 'top'});
                    marker.on('click', () => { selectUnit(d); });
                    markers.push(marker);
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";
            document.getElementById("tableCount").innerText = `(${data.length} Kayƒ±t)`;
            data.forEach(d => {
                const style = styles[d.cat] || styles["mudurluk"];
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><span class="status-dot" style="background:${style.color}"></span>${style.label}</td>
                    <td>${d.dist}</td><td><strong>${d.name}</strong></td><td>${d.app || '-'}</td>
                    <td>${d.is2B ? d.blk : d.p}</td><td>${d.ha || '-'}</td>`;
                tr.onclick = () => {
                    selectUnit(d);
                };
                tbody.appendChild(tr);
            });
        }

        function searchTable() {
            const input = document.getElementById("tableSearch");
            const filter = normalizeText(input.value);
            const tr = document.getElementById("tableBody").getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                const txtValue = tr[i].textContent || tr[i].innerText;
                if (normalizeText(txtValue).indexOf(filter) > -1) tr[i].style.display = "";
                else tr[i].style.display = "none";
            }
        }

        function zoomToLocation() {
            const val = document.getElementById("neighborhoodSelect").value;
            if(!val) return;
            let d = JSON.parse(decodeURIComponent(val));
            if(d.lat) { selectUnit(d); map.flyTo([d.lat, d.lon], 16, {duration: 1.5}); }
        }

        function selectUnit(d) {
            const style = styles[d.cat] || styles["mudurluk"];
            document.getElementById("infoTitle").innerText = d.name;
            document.getElementById("infoBadge").innerText = d.app || style.label;
            document.getElementById("infoBadge").style.backgroundColor = style.color;
            document.getElementById("infoStatus").innerText = `${d.dist} / ${d.status}`;
            const stats = document.getElementById("infoStats");
            stats.innerHTML = '';
            if(d.is2B) {
                stats.innerHTML += `<div class="info-box"><span class="ib-val">${d.blk}</span><span class="ib-lbl">BLOK</span></div>`;
                stats.innerHTML += `<div class="info-box"><span class="ib-val">${d.ha}</span><span class="ib-lbl">HEKTAR</span></div>`;
            } else {
                stats.innerHTML += `<div class="info-box" style="grid-column:span 2"><span class="ib-val">${d.p}</span><span class="ib-lbl">PARSEL</span></div>`;
                if(d.ha > 0) stats.innerHTML += `<div class="info-box" style="grid-column:span 2; margin-top:5px"><span class="ib-val">${d.ha}</span><span class="ib-lbl">HEKTAR</span></div>`;
            }
            document.getElementById("info-card").style.display = "block";
            if(currentMarker) map.removeLayer(currentMarker);
            if(d.lat) {
                currentMarker = L.circleMarker([d.lat, d.lon], {color: "#2c3e50", weight: 3, fillColor: style.color, fillOpacity: 1, radius: 8}).addTo(map).bindPopup(`üìç ${d.name}`).openPopup();
                map.flyTo([d.lat, d.lon], 16, {duration: 1.0});
                autoPilotCorrect(d);
            }
        }

        function togglePanel(e) {
            e.stopPropagation();
            document.getElementById("control-panel").classList.toggle("minimized");
        }
        document.getElementById("control-panel").addEventListener("click", function(e){
            if(this.classList.contains("minimized") && !e.target.closest('.btn-minimize')) this.classList.remove("minimized");
        });
        function toggleBottomPanel() { document.getElementById("bottom-panel").classList.toggle("expanded"); }
        function openTKGM() { window.open("https://parselsorgu.tkgm.gov.tr/", "_blank"); }
        function openNav() {
            if(currentMarker) {
                const ll = currentMarker.getLatLng();
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${ll.lat},${ll.lng}`, "_blank");
            } else alert("L√ºtfen √∂nce bir birim se√ßin.");
        }
        function resetView() {
            map.setView([36.7, 34.0], 9);
            resetSelection();
            setMainFilter('all', document.querySelector('.filter-btn'));
            document.getElementById("districtSelect").value = "all";
            document.getElementById("jobTypeSelect").value = "all";
            applyFilters();
        }
        fetchData();
    </script>
</body>
</html>
